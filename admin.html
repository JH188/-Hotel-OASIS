<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Administrador - Hotel OASIS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: url("img/admin-bg.jpg") no-repeat center center fixed;
      background-size: cover;
      font-family: "Segoe UI", Arial, sans-serif;
      position: relative;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: -1;
    }
    .container { margin-top: 30px; }
    .header {
      background: rgba(13, 110, 253, 0.9);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 25px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
    }
    .header h2 { font-weight: bold; margin-bottom: 6px; }

    .card-section {
      background: rgba(255,255,255,0.97);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    }
    .card-header { font-weight: bold; padding: 12px; border-radius: 8px 8px 0 0; }
    table { background: white; border-radius: 8px; overflow: hidden; }
    th { text-align: center; }
    .activity-log { max-height: 250px; overflow-y: auto; font-size: 0.9rem; }

    /* KPIs */
    .kpi-card {
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .bg-kpi1 { background: linear-gradient(135deg, #0d6efd, #00c3ff); }
    .bg-kpi2 { background: linear-gradient(135deg, #28a745, #218838); }
    .bg-kpi3 { background: linear-gradient(135deg, #ffc107, #e0a800); }
    .bg-kpi4 { background: linear-gradient(135deg, #6f42c1, #6610f2); }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <h2>üëë Panel Administrador - Hotel OASIS</h2>
      <p>Control total de usuarios, habitaciones, reservas y actividad</p>
      <button class="btn btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>
      <button class="btn btn-warning ms-2" onclick="resetGeneral()">‚ôªÔ∏è Resetear Todo</button>
    </div>

    <!-- KPIs -->
    <div class="row mb-4">
      <div class="col-md-3"><div class="kpi-card bg-kpi1"><h4 id="kpiTotal">0</h4><p>Habitaciones Totales</p></div></div>
      <div class="col-md-3"><div class="kpi-card bg-kpi2"><h4 id="kpiDisponibles">0</h4><p>Disponibles</p></div></div>
      <div class="col-md-3"><div class="kpi-card bg-kpi3"><h4 id="kpiOcupadas">0</h4><p>Ocupadas</p></div></div>
      <div class="col-md-3"><div class="kpi-card bg-kpi4"><h4 id="kpiGanancias">S/ 0.00</h4><p>Ganancias</p></div></div>
    </div>

    <!-- CONTROL DE USUARIOS -->
    <div class="card-section">
      <div class="card-header bg-dark text-white"><i class="fa fa-users"></i> Control de Usuarios</div>
      <table class="table table-bordered table-striped text-center mt-3">
        <thead class="table-dark">
          <tr><th>#</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Estado</th><th>Acciones</th></tr>
        </thead>
        <tbody id="tablaUsuarios"></tbody>
      </table>
    </div>

    <!-- GESTI√ìN DE HABITACIONES -->
    <div class="card-section">
      <div class="card-header bg-info text-white"><i class="fa fa-bed"></i> Gesti√≥n de Habitaciones</div>
      <button class="btn btn-success mb-2" onclick="nuevaHabitacion()">‚ûï A√±adir Habitaci√≥n</button>
      <table class="table table-bordered text-center mt-2">
        <thead class="table-dark">
          <tr><th>ID</th><th>Tipo</th><th>Precio</th><th>Estado</th><th>Acciones</th></tr>
        </thead>
        <tbody id="tablaHabitaciones"></tbody>
      </table>
    </div>

    <!-- REGISTRO DE RESERVAS -->
    <div class="card-section">
      <div class="card-header bg-primary text-white"><i class="fa fa-list"></i> Registro de Reservas</div>
      <table class="table table-bordered table-striped text-center mt-3">
        <thead class="table-dark">
          <tr>
            <th>#</th><th>Hu√©sped</th><th>Habitaci√≥n</th><th>Ingreso</th><th>Salida</th>
            <th>M√©todo Pago</th><th>Total</th><th>Estado</th>
          </tr>
        </thead>
        <tbody id="tablaAdmin"></tbody>
      </table>
    </div>

    <!-- HISTORIAL -->
    <div class="card-section">
      <div class="card-header bg-warning text-dark"><i class="fa fa-history"></i> Historial de Actividad</div>
      <div class="activity-log mt-3" id="actividadLog"><p class="text-muted">No hay actividad registrada a√∫n...</p></div>
    </div>

    <!-- REPORTES -->
    <div class="card-section">
      <div class="card-header bg-success text-white">üìä Reportes y Estad√≠sticas</div>
      <div class="row mt-3">
        <div class="col-md-6"><canvas id="chartUsuarios"></canvas></div>
        <div class="col-md-6"><canvas id="chartReservas"></canvas></div>
      </div>
    </div>
  </div>

  <script src="js.js"></script>
  <script>
    // === PANEL COMPLETO ===
    function actualizarPanelAdmin() {
      mostrarUsuariosAdmin();
      mostrarHabitaciones();
      mostrarReservasAdmin();
      actualizarKPIs();
      cargarGraficos();
    }

    // === USUARIOS ===
    function mostrarUsuariosAdmin() {
      const users = JSON.parse(localStorage.getItem("usuarios")) || [];
      const bloqueados = JSON.parse(localStorage.getItem("usuariosBloqueados")) || [];
      const tabla = document.getElementById("tablaUsuarios");
      tabla.innerHTML = "";
      users.forEach((u, i) => {
        const bloqueado = bloqueados.includes(u.email);
        tabla.innerHTML += `
          <tr>
            <td>${i+1}</td>
            <td>${u.nombre}</td>
            <td>${u.email}</td>
            <td>${u.rol || "Usuario"}</td>
            <td>${bloqueado ? "‚õî Bloqueado" : "‚úÖ Activo"}</td>
            <td>
              <button class="btn btn-warning btn-sm" onclick="botarUsuario('${u.email}')">üö™ Botar</button>
              <button class="btn btn-danger btn-sm" onclick="bloquearUsuario('${u.email}')">
                ${bloqueado ? "üîì Desbloquear" : "‚õî Bloquear"}
              </button>
              <button class="btn btn-secondary btn-sm" onclick="resetUsuario('${u.email}')">‚ôªÔ∏è Reset</button>
            </td>
          </tr>`;
      });
    }

    // === RESET INDIVIDUAL ===
    function resetUsuario(email) {
      localStorage.removeItem(`reservas_${email}`);
      let data = getHotelData();
      data.reservas = data.reservas.filter(r => r.usuarioEmail !== email);
      data.ocupadas = data.reservas.filter(r => r.estado === "Activa").length;
      data.disponibles = data.total - data.ocupadas;
      setHotelData(data);

      registrarActividad(`‚ôªÔ∏è Reset de reservas para ${email}`);
      localStorage.setItem("lastUpdate", Date.now());
      actualizarPanelAdmin();
    }

    // === RESET GENERAL ===
    function resetGeneral() {
      if (!confirm("‚ö†Ô∏è Esto borrar√° todas las reservas de todos los usuarios. ¬øSeguro?")) return;
      localStorage.removeItem("hotelData");

      // limpiar reservas individuales
      const users = JSON.parse(localStorage.getItem("usuarios")) || [];
      users.forEach(u => localStorage.removeItem(`reservas_${u.email}`));

      registrarActividad("‚ôªÔ∏è Reset general aplicado a todos los usuarios");
      localStorage.setItem("lastUpdate", Date.now());
      actualizarPanelAdmin();
    }

    // === RESERVAS ===
    function mostrarReservasAdmin() {
      const data = getHotelData();
      const reservas = data.reservas || [];
      const tabla = document.getElementById("tablaAdmin");
      tabla.innerHTML = "";
      let totalGanancias = 0;
      if (reservas.length === 0) {
        tabla.innerHTML = `<tr><td colspan="8" class="text-muted">No hay reservas a√∫n</td></tr>`;
        return;
      }
      reservas.forEach((r, i) => {
        totalGanancias += r.total || 0;
        tabla.innerHTML += `
          <tr>
            <td>${i+1}</td><td>${r.nombre}</td><td>${r.habitacion}</td>
            <td>${r.ingreso}</td><td>${r.salida}</td>
            <td>${r.metodoPago || "No registrado"}</td>
            <td>S/ ${(r.total || 0).toFixed(2)}</td>
            <td><strong>${r.estado}</strong></td>
          </tr>`;
      });
      document.getElementById("kpiGanancias").innerText = "S/ " + totalGanancias.toFixed(2);
    }

    // === KPIs ===
    function actualizarKPIs() {
      const data = getHotelData();
      document.getElementById("kpiTotal").innerText = data.total;
      document.getElementById("kpiDisponibles").innerText = data.disponibles;
      document.getElementById("kpiOcupadas").innerText = data.ocupadas;
    }

    // === HISTORIAL ===
    function registrarActividad(mensaje) {
      const log = document.getElementById("actividadLog");
      const fecha = new Date().toLocaleString();
      log.innerHTML = `<p>üìå [${fecha}] ${mensaje}</p>` + log.innerHTML;
    }

    // === GR√ÅFICOS ===
    let chartUsuariosRef = null;
    let chartReservasRef = null;
    function cargarGraficos() {
      const data = getHotelData();
      const activos = (JSON.parse(localStorage.getItem("usuarios")) || []).length;
      const bloqueados = (JSON.parse(localStorage.getItem("usuariosBloqueados")) || []).length;

      if (chartUsuariosRef) chartUsuariosRef.destroy();
      chartUsuariosRef = new Chart(document.getElementById("chartUsuarios"), {
        type: "doughnut",
        data: { 
          labels: ["Activos", "Bloqueados"], 
          datasets: [{ data: [activos, bloqueados], backgroundColor: ["#28a745","#dc3545"] }] 
        }
      });

      const reservasPorMes = Array(12).fill(0);
      data.reservas.forEach(r => { reservasPorMes[new Date(r.ingreso).getMonth()]++; });

      if (chartReservasRef) chartReservasRef.destroy();
      chartReservasRef = new Chart(document.getElementById("chartReservas"), {
        type: "bar",
        data: { 
          labels: ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],
          datasets: [{ label: "Reservas", data: reservasPorMes, backgroundColor:"#0d6efd"}] 
        }
      });
    }

    // === INICIO ===
    document.addEventListener("DOMContentLoaded", () => {
      actualizarPanelAdmin();
      registrarActividad("Administrador inici√≥ sesi√≥n.");
    });

    // üîÑ Tiempo real
    window.addEventListener("storage", (e) => {
      if (e.key === "lastUpdate") actualizarPanelAdmin();
    });
    setInterval(actualizarPanelAdmin, 3000);

    // üö™ Logout
    function logout() {
      localStorage.removeItem("usuarioActivo");
      window.location.href = "login.html";
    }
  </script>
</body>
</html>
